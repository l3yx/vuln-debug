# Spring Security 权限绕过(CVE-2022-22978)


在Java中正则表达式`.`默认不包含`\n` 和`\r`，需要设置`DOTALL`才会匹配所有字符。而`Spring Security`在通过正则设置路由权限时，未设置`DOTALL`，导致某些情况下可以通过`\n` 和`\r`来绕过权限控制。


## 影响范围

- Spring Security
  - 5.6.x - 5.6.4
  - 5.5.x - 5.5.7
  - ...

## 环境搭建

```bash
git clone https://github.com/l3yx/vuln-debug.git
cd vuln-debug/SpringSecurity/CVE-2022-22978
docker-compose up -d
```

## 漏洞复现

Spring Security配置如下：

![image-20220716203325350](Spring-Security-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87-CVE-2022-22978/image-20220716203325350.png)

Controller如下：

![image-20220716213004515](Spring-Security-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87-CVE-2022-22978/image-20220716213004515.png)

正常访问返回403：

![image-20220716203148959](Spring-Security-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87-CVE-2022-22978/image-20220716203148959.png)

使用`\r`或者`\n`绕过：

![image-20220716203124768](Spring-Security-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87-CVE-2022-22978/image-20220716203124768.png)

## 漏洞分析

由官方公告[CVE-2022-22978: Authorization Bypass in RegexRequestMatcher](https://spring.io/blog/2022/05/15/cve-2022-22978-authorization-bypass-in-regexrequestmatcher)，漏洞和`RegexRequestMatcher`有关。

![image-20220716183917080](Spring-Security-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87-CVE-2022-22978/image-20220716183917080.png)

对比漏洞版本5.5.6和已修复版本5.5.7https://github.com/spring-projects/spring-security/compare/5.5.6..5.5.7

![image-20220716184215116](Spring-Security-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87-CVE-2022-22978/image-20220716184215116.png)

![image-20220716184242715](Spring-Security-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87-CVE-2022-22978/image-20220716184242715.png)

在Java中正则表达式`.`默认不包含`\n` 和`\r`，需要设置`DOTALL`才会匹配所有字符。